{% extends "user/layout.html" %}

{% block title %}My Account{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/user/account.css') }}">
{% endblock %}

{% block content %}
<div class="account-header">
    <h1><i class="fas fa-user-circle"></i> My Account</h1>
</div>

<!-- User Welcome Section -->
<div class="user-welcome">
    <div>
        <p><i class="fas fa-user"></i> Welcome back, <strong>{{ current_user.user_name }}</strong>!</p>
    </div>
    <div>
        <span class="last-login">Last login: March 3, 2024 10:30</span> <!-- Note: Date is hardcoded, consider making dynamic -->
    </div>
</div>

<!-- Display Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="messages">
            {% for category, message in messages %}
                <div class="message {{ category }}">
                    {% if category == 'success' %}
                        <i class="fas fa-check-circle"></i>
                    {% elif category == 'error' %}
                        <i class="fas fa-exclamation-circle"></i>
                    {% else %}
                        <i class="fas fa-info-circle"></i>
                    {% endif %}
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

<!-- Account Balance and Actions -->
<div class="balance-display">
    <h2><i class="fas fa-wallet"></i> Account Balance</h2>
    <div class="balance-info">
        <div class="balance-item">
            <p class="balance-label">Available Balance</p>
            <p class="current-balance">¥ {{ balance.available_balance|safe_round(2) }}</p>
        </div>
        <div class="balance-item">
            <p class="balance-label">Frozen Balance</p>
            <p class="frozen-balance">¥ {{ balance.frozen_balance|safe_round(2) }}</p>
        </div>
        <div class="balance-item">
            <p class="balance-label">Total Balance</p>
            <p class="total-balance">¥ {{ balance.total_balance|safe_round(2) }}</p>
        </div>
    </div>
    
    <!-- Deposit and Withdraw Buttons -->
    <div class="balance-actions">
        <button class="action-btn deposit-btn" data-bs-toggle="modal" data-bs-target="#depositModal">
            <i class="fas fa-plus-circle"></i> Deposit
        </button>
        <button class="action-btn withdraw-btn" data-bs-toggle="modal" data-bs-target="#withdrawalModal">
            <i class="fas fa-minus-circle"></i> Withdraw
        </button>
    </div>
</div>

<!-- Portfolio Section -->
<div class="portfolio-section">
    <h2><i class="fas fa-chart-pie"></i> My Portfolio</h2>
    
    {% if portfolio %}
    <div class="portfolio-table">
        <table>
            <thead>
                <tr>
                    <th>Ticker</th>
                    <th>Quantity</th>
                    <th>Average Cost</th>
                    <th>Current Price</th>
                    <th>Market Value</th>
                    <th>P&L</th>
                    <th>P&L %</th>
                </tr>
            </thead>
            <tbody>
                {% for position in portfolio %}
                <tr>
                    <td>{{ position.ticker }}</td>
                    <td>{{ position.quantity }}</td>
                    <td>¥ {{ position.average_price|safe_round(2) }}</td>
                    <td>¥ {{ position.current_price|safe_round(2) }}</td>
                    <td>¥ {{ position.market_value|safe_round(2) }}</td>
                    <td class="{% if position.pnl >= 0 %}positive{% else %}negative{% endif %}">
                        {{ position.pnl|safe_round(2) }}
                    </td>
                    <td class="{% if position.pnl_percentage >= 0 %}positive{% else %}negative{% endif %}">
                        {{ position.pnl_percentage|safe_round(2) }}%
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-portfolio">
        <p><i class="fas fa-info-circle"></i> You currently have no holdings.</p>
        <a href="{{ url_for('user.stock_chart') }}" class="cta-button">Go to Trade</a>
    </div>
    {% endif %}
</div>

<!-- Transaction History -->
<div class="section">
    <h2><i class="fas fa-history"></i> My Transaction History</h2>
    {% if transactions %}
        <div class="table-responsive">
            <table class="order-table">
                <thead>
                    <tr>
                        <th>Transaction ID</th>
                        <th>Order ID</th>
                        <th>Type</th>
                        <th>Details</th>
                        <th>Amount</th>
                        <th>Transaction Time</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transaction in transactions %}
                        <tr>
                            <td><small>{{ transaction.transaction_id }}</small></td>
                            <td><small>{{ transaction.order_id }}</small></td>
                            <td>
                                {% if transaction.transaction_type == 'buy' %}
                                    <span class="transaction-tag tag-buy">Buy</span>
                                {% elif transaction.transaction_type == 'sell' %}
                                    <span class="transaction-tag tag-sell">Sell</span>
                                {% elif transaction.transaction_type == 'deposit' %}
                                    <span class="transaction-tag tag-deposit">Deposit</span>
                                {% else %}
                                    {{ transaction.transaction_type }}
                                {% endif %}
                            </td>
                            <td>
                                {% if transaction.transaction_type == 'deposit' %}
                                    Account Deposit
                                {% else %}
                                    <strong>{{ transaction.ticker }}</strong> × {{ transaction.transaction_quantity }}<br>
                                    <small>Unit Price: ¥{{ transaction.transaction_price|safe_round(2) }}</small>
                                {% endif %}
                            </td>
                            <td>
                                {# Explicitly convert enum to string for comparison #}
                                {% if transaction.transaction_type|string == 'buy' %}
                                    <span class="negative-amount">-¥{{ transaction.transaction_amount|safe_round(2) }}</span>
                                {% else %}
                                    <span class="positive-amount">+¥{{ transaction.transaction_amount|safe_round(2) }}</span>
                                {% endif %}
                            </td>
                            <td>{{ transaction.transaction_time }}</td>
                            <td>
                                {% if transaction.transaction_status == 'completed' %}
                                    <span class="status-completed">Completed</span>
                                {% elif transaction.transaction_status == 'failed' %}
                                    <span class="status-failed">Failed</span>
                                {% elif transaction.transaction_status == 'reversed' %}
                                    <span class="status-reversed">Reversed</span>
                                {% else %}
                                    {{ transaction.transaction_status }}
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p class="no-data-message"><i class="fas fa-info-circle"></i> No transaction history yet</p>
    {% endif %}
</div>

<!-- Deposit/Withdrawal History -->
<div class="section">
    <h2><i class="fas fa-money-bill-wave"></i> Deposit & Withdrawal History</h2>
    {% if fund_transactions %}
        <div class="table-responsive">
            <table class="order-table">
                <thead>
                    <tr>
                        <th>Transaction ID</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Amount</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody>
                    {% for fund_tx in fund_transactions %}
                        <tr>
                            <td>{{ fund_tx.transaction_id }}</td>
                            <td>
                                {% if fund_tx.transaction_type == 'deposit' %}
                                    <span class="transaction-tag tag-deposit">Deposit</span>
                                {% elif fund_tx.transaction_type == 'withdrawal' %}
                                    <span class="transaction-tag tag-withdraw">Withdrawal</span>
                                {% else %}
                                    {{ fund_tx.transaction_type }}
                                {% endif %}
                            </td>
                            <td>
                                {% if fund_tx.status == 'pending' %}
                                    <span class="status-pending">Pending</span>
                                {% elif fund_tx.status == 'approved' or fund_tx.status == 'completed' %}
                                    <span class="status-completed">Completed</span>
                                {% elif fund_tx.status == 'rejected' %}
                                    <span class="status-cancelled">Rejected</span>
                                {% else %}
                                    {{ fund_tx.status }}
                                {% endif %}
                            </td>
                            <td>
                                {% if fund_tx.transaction_type == 'deposit' %}
                                    <span class="positive-amount">+¥{{ fund_tx.amount|safe_round(2) }}</span>
                                {% else %}
                                    <span class="negative-amount">-¥{{ fund_tx.amount|safe_round(2) }}</span>
                                {% endif %}
                            </td>
                            <td>{{ fund_tx.created_at }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p class="no-data-message"><i class="fas fa-info-circle"></i> No deposit/withdrawal history yet</p>
    {% endif %}
</div>

<!-- Order List -->
<div class="section">
    <h2><i class="fas fa-list"></i> My Orders</h2>
    {% if orders %}
        <div class="table-responsive">
            <table class="order-table">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Ticker</th>
                        <th>Type</th>
                        <th>Order Type</th>
                        <th>Price</th>
                        <th>Quantity</th>
                        <th>Status</th>
                        <th>Created Time</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders %}
                        <tr>
                            <td><small>{{ order.order_id }}</small></td>
                            <td><strong>{{ order.ticker }}</strong></td>
                            <td>
                                {% if order.order_type == 'buy' or order.order_type.value == 'buy' %}
                                    <span class="transaction-tag tag-buy">Buy</span>
                                {% else %}
                                    <span class="transaction-tag tag-sell">Sell</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if order.order_execution_type == 'market' or order.order_execution_type.value == 'market' or order.order_execution_type == 'MARKET' %}
                                    <span class="transaction-tag tag-market">Market</span>
                                {% else %}
                                    <span class="transaction-tag tag-limit">Limit</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if order.order_price %}
                                    ¥{{ order.order_price|safe_round(2) }}
                                {% elif order.order_execution_type == 'market' %}
                                    Market Price
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>{{ order.order_quantity }}</td>
                            <td>
                                {% if order.order_status == 'pending' %}
                                    <span class="status-pending">Pending</span>
                                {% elif order.order_status == 'executed' %}
                                    <span class="status-executed">Executed</span>
                                {% elif order.order_status == 'cancelled' %}
                                    <span class="status-cancelled">Cancelled</span>
                                {% elif order.order_status == 'failed' %}
                                    <span class="status-failed">Failed</span>
                                    {% if order.remark %}
                                    <span class="order-note" title="{{ order.remark }}"><i class="fas fa-info-circle"></i></span>
                                    {% endif %}
                                {% else %}
                                    {{ order.order_status }}
                                {% endif %}
                            </td>
                            <td>{{ order.created_at }}</td>
                            <td>
                                {% if order.order_status == 'pending' %}
                                    <form action="{{ url_for('user.cancel_order', order_id=order.order_id) }}" method="post">
                                        <button type="submit" class="btn-small danger"><i class="fas fa-times"></i> Cancel</button>
                                    </form>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="empty-orders">
            <p><i class="fas fa-info-circle"></i> You have no order history yet.</p>
            <a href="{{ url_for('user.stock_chart') }}" class="cta-button">Go to Trade</a>
        </div>
    {% endif %}
</div>

<!-- Deposit Modal -->
<div class="modal fade" id="depositModal" tabindex="-1" aria-labelledby="depositModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="depositModalLabel">Account Deposit</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="depositForm">
                    <div class="mb-3">
                        <label for="amount" class="form-label">Deposit Amount</label>
                        <input type="number" class="form-control" id="amount" name="amount" required min="0.01" step="0.01">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="depositForm" class="btn btn-primary">Confirm Deposit</button>
            </div>
        </div>
    </div>
</div>

<!-- Withdrawal Modal -->
<div class="modal fade" id="withdrawalModal" tabindex="-1" aria-labelledby="withdrawalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="withdrawalModalLabel">Account Withdrawal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="withdrawalForm">
                    <div class="mb-3">
                        <p class="balance-info">Current Available Balance: <span id="availableBalance" data-balance="{{ balance.available_balance }}">¥ {{ balance.available_balance|safe_round(2) }}</span></p>
                        <label for="withdrawAmount" class="form-label">Withdrawal Amount</label>
                        <input type="number" class="form-control" id="withdrawAmount" name="amount" required min="0.01" step="0.01">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="withdrawalForm" class="btn btn-primary">Confirm Withdrawal</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/user/account.js') }}"></script>
{% endblock %}