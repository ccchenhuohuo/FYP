{% extends "user/layout.html" %}

{% block title %}Stock History Chart{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/user/stock_chart.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header my-4">
        <h1><i class="fas fa-chart-line text-primary"></i> Stock History and Forecast Analysis</h1>
        <p class="text-muted">Explore future stock performance through historical data and Monte Carlo simulation</p>
    </div>
    
    <!-- Chart Control Panel -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title"><i class="fas fa-sliders-h"></i> Chart Controls</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="stockSelector"><i class="fas fa-search"></i> Select Stock</label>
                        <select class="form-control" id="stockSelector">
                            <option value="AAPL">Apple Inc. (AAPL)</option>
                            <option value="GOOGL">Alphabet Inc. (GOOGL)</option>
                            <option value="MSFT">Microsoft Corp. (MSFT)</option>
                            <option value="AMZN">Amazon.com Inc. (AMZN)</option>
                            <option value="META">Meta Platforms Inc. (META)</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="timeRange"><i class="fas fa-calendar-alt"></i> Time Range</label>
                        <select class="form-control" id="timeRange">
                            <option value="1m">1 Month</option>
                            <option value="3m">3 Months</option>
                            <option value="6m">6 Months</option>
                            <option value="1y">1 Year</option>
                            <option value="all" selected>All</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Real-time Stock Data -->
    <div class="card mb-4" id="realTimeDataCard">
        <div class="card-header">
            <h5 class="card-title"><i class="fas fa-bolt"></i> Real-time Quote</h5>
        </div>
        <div class="card-body">
            <div id="loadingRealTimeData" class="text-center py-3">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span class="ms-2">Fetching real-time data...</span>
            </div>
            <div id="realTimeDataError" class="alert alert-danger" style="display: none;"></div>
            
            <div id="realTimeDataContent" style="display: none;">
                <div class="real-time-data-grid">
                    <div class="real-time-item">
                        <div class="label"><i class="fas fa-dollar-sign"></i> Current Price</div>
                        <div class="value" id="rtPrice">--</div>
                        <div class="change" id="rtPriceChange">--</div>
                    </div>
                    
                    <div class="real-time-item">
                        <div class="label"><i class="fas fa-chart-bar"></i> Volume</div>
                        <div class="value" id="rtVolume">--</div>
                    </div>
                    
                    <div class="real-time-item">
                        <div class="label"><i class="fas fa-arrow-up"></i> Today's High</div>
                        <div class="value" id="rtHigh">--</div>
                    </div>
                    
                    <div class="real-time-item">
                        <div class="label"><i class="fas fa-arrow-down"></i> Today's Low</div>
                        <div class="value" id="rtLow">--</div>
                    </div>
                </div>
                
                <div class="text-end mt-3">
                    <small class="text-muted" id="lastUpdated">Last Updated: --</small>
                    <button class="btn btn-sm btn-outline-primary ms-2" id="refreshRealTimeData">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Display Area -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title"><i class="fas fa-chart-area"></i> Price Chart</h5>
        </div>
        <div class="card-body chart-wrapper">
            <div id="loadingMessage" style="display: none;" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span class="ms-2">Loading data...</span>
            </div>
            <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>
            <canvas id="stockChart"></canvas>
        </div>
    </div>

    <!-- Monte Carlo Simulation Control Panel -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title"><i class="fas fa-random"></i> Monte Carlo Simulation Forecast</h5>
        </div>
        <div class="card-body">
            <div class="row align-items-end">
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="simulationDays"><i class="fas fa-calendar"></i> Simulation Days</label>
                        <input type="number" class="form-control" id="simulationDays" value="60" min="1" max="365">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="simulationCount"><i class="fas fa-dice"></i> Simulation Count</label>
                        <input type="number" class="form-control" id="simulationCount" value="200" min="100" max="10000">
                    </div>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary w-100" id="simulateButton">
                        <i class="fas fa-play"></i> Run Simulation
                    </button>
                </div>
            </div>
            
            <!-- View Mode Toggle -->
            <div id="viewModeToggle" class="btn-group mt-4" style="display: none;">
                <button type="button" class="btn btn-outline-secondary" id="historyModeBtn">
                    <i class="fas fa-history"></i> Focus on Historical Data
                </button>
                <button type="button" class="btn btn-outline-secondary active" id="simulationModeBtn">
                    <i class="fas fa-chart-line"></i> Focus on Simulation Paths
                </button>
            </div>
            
            <div id="simulationStats" class="mt-4 p-3 bg-light rounded" style="display: none;"></div>
        </div>
    </div>

    <!-- Fundamental Data Section -->
    <div class="fundamental-section">
        <div class="fundamental-header">
            <h2><i class="fas fa-chart-pie"></i> Company Fundamentals</h2>
        </div>
        
        <!-- Tab Navigation -->
        <div class="fundamental-tabs">
            <button id="tabFundamental" class="tab-button active">
                <i class="fas fa-info-circle"></i> Key Metrics
            </button>
            <button id="tabBalance" class="tab-button">
                <i class="fas fa-balance-scale"></i> Balance Sheet
            </button>
            <button id="tabIncome" class="tab-button">
                <i class="fas fa-file-invoice-dollar"></i> Income Statement
            </button>
        </div>
        
        <!-- Key Metrics Content -->
        <div id="contentFundamental" class="tab-content active">
            <div class="loading-data" id="loadingFundamental">
                <div class="loading-spinner"></div>
                <p>Loading fundamental data...</p>
            </div>
            
            <div class="error-message" id="errorFundamental" style="display: none;">
                <i class="fas fa-exclamation-circle"></i> <span></span>
            </div>
            
            <div class="data-grid" id="fundamentalData" style="display: none;">
                <div class="data-item">
                    <h4><i class="fas fa-dollar-sign"></i> Market Cap</h4>
                    <p class="value" id="marketCap">-</p>
                </div>
                
                <div class="data-item">
                    <h4><i class="fas fa-chart-line"></i> P/E Ratio</h4>
                    <p class="value" id="peRatio">-</p>
                </div>
                
                <div class="data-item">
                    <h4><i class="fas fa-book"></i> P/B Ratio</h4>
                    <p class="value" id="pbRatio">-</p>
                </div>
                
                <div class="data-item">
                    <h4><i class="fas fa-hand-holding-usd"></i> Dividend Yield</h4>
                    <p class="value" id="dividendYield">-</p>
                </div>
                
                <div class="data-item">
                    <h4><i class="fas fa-money-bill-wave"></i> Revenue</h4>
                    <p class="value" id="revenue">-</p>
                </div>
                
                <div class="data-item">
                    <h4><i class="fas fa-piggy-bank"></i> Net Income</h4>
                    <p class="value" id="netIncome">-</p>
                </div>
                
                <div class="data-item">
                    <h4><i class="fas fa-stream"></i> Operating Cash Flow</h4>
                    <p class="value" id="operatingCashFlow">-</p>
                </div>
            </div>
            
            <p class="data-note" id="fundamentalDate"></p>
        </div>
        
        <!-- Balance Sheet Content -->
        <div id="contentBalance" class="tab-content">
            <div class="loading-data" id="loadingBalance">
                <div class="loading-spinner"></div>
                <p>Loading balance sheet data...</p>
            </div>
            
            <div class="error-message" id="errorBalance" style="display: none;">
                <i class="fas fa-exclamation-circle"></i> <span></span>
            </div>
            
            <div id="balanceData" style="display: none;">
                <div class="data-grid">
                    <div class="data-item">
                        <h4><i class="fas fa-wallet"></i> Current Assets</h4>
                        <p class="value" id="currentAssets">-</p>
                    </div>
                    
                    <div class="data-item">
                        <h4><i class="fas fa-building"></i> Non-Current Assets</h4>
                        <p class="value" id="nonCurrentAssets">-</p>
                    </div>
                    
                    <div class="data-item">
                        <h4><i class="fas fa-layer-group"></i> <strong>Total Assets</strong></h4>
                        <p class="value" id="totalAssets">-</p>
                    </div>
                    
                    <div class="data-item">
                        <h4><i class="fas fa-file-invoice-dollar"></i> Current Liabilities</h4>
                        <p class="value" id="currentLiabilities">-</p>
                    </div>
                    
                    <div class="data-item">
                        <h4><i class="fas fa-university"></i> Non-Current Liabilities</h4>
                        <p class="value" id="nonCurrentLiabilities">-</p>
                    </div>
                    
                    <div class="data-item">
                        <h4><i class="fas fa-money-check-alt"></i> <strong>Total Liabilities</strong></h4>
                        <p class="value" id="totalLiabilities">-</p>
                    </div>
                    
                    <div class="data-item">
                        <h4><i class="fas fa-chart-pie"></i> <strong>Shareholder Equity</strong></h4>
                        <p class="value" id="equity">-</p>
                    </div>
                </div>
                
                <p class="data-note" id="balanceDate"></p>
            </div>
        </div>
        
        <!-- Income Statement Content -->
        <div id="contentIncome" class="tab-content">
            <div class="loading-data" id="loadingIncome">
                <div class="loading-spinner"></div>
                <p>Loading income statement data...</p>
            </div>
            
            <div class="error-message" id="errorIncome" style="display: none;">
                <i class="fas fa-exclamation-circle"></i> <span></span>
            </div>
            
            <div id="incomeData" style="display: none;">
                <div class="data-grid">
                    <div class="data-item">
                        <h4><i class="fas fa-hand-holding-usd"></i> Total Revenue</h4>
                        <p class="value" id="incomeRevenue">-</p>
                    </div>
                    
                    <div class="data-item">
                        <h4><i class="fas fa-money-bill-wave"></i> Cost of Revenue</h4>
                        <p class="value" id="costOfRevenue">-</p>
                    </div>
                    
                    <div class="data-item">
                        <h4><i class="fas fa-dollar-sign"></i> <strong>Gross Profit</strong></h4>
                        <p class="value" id="grossProfit">-</p>
                    </div>
                    
                    <div class="data-item">
                        <h4><i class="fas fa-chart-line"></i> Operating Income</h4>
                        <p class="value" id="operatingIncome">-</p>
                    </div>
                    
                    <div class="data-item">
                        <h4><i class="fas fa-coins"></i> Income Before Tax</h4>
                        <p class="value" id="incomeBeforeTax">-</p>
                    </div>
                    
                    <div class="data-item">
                        <h4><i class="fas fa-piggy-bank"></i> <strong>Net Income</strong></h4>
                        <p class="value" id="incomeNetIncome">-</p>
                    </div>
                    
                    <div class="data-item">
                        <h4><i class="fas fa-percentage"></i> <strong>Profit Margin</strong></h4>
                        <p class="value" id="profitMargin">-</p>
                    </div>
                </div>
                
                <p class="data-note" id="incomeDate"></p>
            </div>
        </div>
    </div>

    <!-- Create New Order Form -->
    <div class="card mt-4">
        <div class="card-header">
            <h3><i class="fas fa-file-invoice"></i> Create New Order</h3>
            <p class="text-muted mb-0">Create an order for the currently selected stock</p>
        </div>
        <div class="card-body">
            <form id="orderForm" class="order-form">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="order_type"><i class="fas fa-exchange-alt"></i> Order Type:</label>
                            <select id="order_type" name="order_type" class="form-control" required>
                                <option value="buy">Buy</option>
                                <option value="sell">Sell</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="order_execution_type"><i class="fas fa-cogs"></i> Execution Type:</label>
                            <select id="order_execution_type" name="order_execution_type" class="form-control" required>
                                <option value="limit">Limit Order</option>
                                <option value="market">Market Order</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3 price-field">
                            <label for="price"><i class="fas fa-dollar-sign"></i> Price:</label>
                            <input type="number" id="price" name="price" class="form-control" min="0.01" step="0.01" required placeholder="Enter price">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="quantity"><i class="fas fa-sort-amount-up"></i> Quantity:</label>
                            <input type="number" id="quantity" name="quantity" class="form-control" min="1" required placeholder="Enter quantity">
                        </div>
                    </div>
                </div>
                <!-- Add hidden ticker field to record the currently selected stock -->
                <input type="hidden" id="ticker" name="ticker">
                <div class="row">
                    <div class="col-12">
                        <div class="form-group mb-3">
                            <button type="submit" class="btn btn-primary btn-lg w-100">
                                <i class="fas fa-plus-circle"></i> Create Order
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Include Chart.js library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.3/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.min.js"></script>

<!-- Include custom JavaScript -->
<script src="{{ url_for('static', filename='js/user/stock_chart.js') }}"></script>
<script src="{{ url_for('static', filename='js/user/stock_chart_extra.js') }}"></script>
{% endblock %} 